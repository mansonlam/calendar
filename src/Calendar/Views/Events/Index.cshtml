@using Microsoft.AspNetCore.Authorization;
@using System.Security.Claims;

@model IEnumerable<Calendar.Models.Event>

@inject Calendar.Models.Services.StaticListOfValuesService LOVs
@inject Calendar.Controllers.AppSettingsController appsettings

@{
    ViewData["Title"] = "Event List";
}

<h2>@ViewData["Title"]</h2>

@if (@User.IsInRole("Admins"))
{
<p>
    <a asp-action="Create">Create New</a>
</p>
}

<!--<table class="table" style="table-layout:fixed">-->
<table class="table table-striped table-bordered table-hover">
    <thead class="thead-inverse" style="color:#eceeef;background-color:#373a3c">
        <tr>
        @if (User.IsInRole("Admins"))
        {
            <th width="8%"></th>
        }
        else
        {
            <th></th>
        }
            <th width="12%">
                @Html.DisplayNameFor(model => model.StartDateTime)
                <span class="text-nowrap">
                    <a asp-action="Index" asp-route-sort="sd_a" title="Ascending Order"><span class='glyphicon glyphicon-chevron-up' style='color:@((ViewBag.SortParm=="sd_a")?"red": "white")'></span></a>
                    <a asp-action="Index" asp-route-sort="sd_d" title="Descending Order"><span class='glyphicon glyphicon-chevron-down' style='color:@((ViewBag.SortParm=="sd_d") ?"red": "white")'></span></a>
                </span>
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Category)
            </th>
            <th width="25%">
                @Html.DisplayNameFor(model => model.Subject)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.AffectedHosts)
            </th>
            <th width="10%">
                @Html.DisplayNameFor(model => model.AffectedProjects)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.AffectedTeams)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.EventStatus)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Reference)
            </th>
            <th width="10%">
                @Html.DisplayNameFor(model => model.CreatedDate)
                <span class="text-nowrap">
                    <a asp-action="Index" asp-route-sort="cd_a" title="Ascending Order"><span class='glyphicon glyphicon-chevron-up' style='color:@((ViewBag.SortParm=="cd_a")?"red":"white")'></span></a>
                    <a asp-action="Index" asp-route-sort="cd_d" title="Descending Order"><span class='glyphicon glyphicon-chevron-down' style='color:@((ViewBag.SortParm=="cd_d")?"red": "white")'></span></a>
                </span>
            </th>
            <th width="10%">
                @Html.DisplayNameFor(model => model.UpdatedDate)
                <span class="text-nowrap">
                    <a asp-action="Index" asp-route-sort="ud_a" title="Ascending Order"><span class='glyphicon glyphicon-chevron-up' style='color:@((ViewBag.SortParm=="ud_a")?"red":"white")'></span></a>
                    <a asp-action="Index" asp-route-sort="ud_d" title="Descending Order"><span class='glyphicon glyphicon-chevron-down' style='color:@((ViewBag.SortParm=="ud_d")?"red": "white")'></span></a>
                </span>
            </th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model)
{
        <tr>
            <td>
                @if (User.IsInRole("Admins"))
                {
                    <a class="btn btn-default btn-xs glyphicon glyphicon-trash" role="button" asp-action="Delete" asp-route-id="@item.ID" title="Delete the event"></a>
                    <a class="btn btn-default btn-xs glyphicon glyphicon-duplicate" role="button" asp-action="Copy" asp-route-id="@item.ID" title="Make a copy of the event"></a>
                }
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.StartDateTime)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Category)
            </td>
            <td>
                @{
                    var redir = Uri.UnescapeDataString(@Context.Request.PathBase + "/Events?sort=" + @ViewBag.SortParm);
                    var action = (User.IsInRole("Admins") ? "Edit" : "Details");
                    <a role="button" style="text-decoration:none;" asp-action="@action" asp-route-id="@item.ID" asp-route-redir="@redir">@item.Subject</a>
                }
                @* @Html.DisplayFor(modelItem => item.Subject) *@
            </td>
            <td>
                @{
                    String affectedhosts = item.AffectedHosts.Replace(",", ", ");
                    @affectedhosts
                    <a target=_blank href="@appsettings.IA_Url?broken=true&server=@item.AffectedHosts"><span class='glyphicon glyphicon-flash' style='color:red' title='Perform Impact Analysis'></span></a>
                }
            </td>
            <td>
                @{
                    String affectedprojects = item.AffectedProjects.Replace(",", ", ");
                    @affectedprojects
                    <a target=_blank href="@appsettings.IA_Url?system=@item.AffectedProjects"><span class='glyphicon glyphicon-flash' style='color:red' title='Perform Impact Analysis'></span></a>
                }
            </td>
            <td>
                @{
                    String affectedteams = item.AffectedTeams.Replace(",", ", ");
                    @affectedteams
                }
            </td>
            <td>
                @{
                    // It wounld be better to do it using CalendarEventViewModel
                    var s = LOVs.ListEventStatus().Where(m => m.Value == item.EventStatus);                    
                    @if (s.Count() == 1)
                    {
                        @Html.DisplayFor(modelItem => s.First().Name);
                    }
                    else { 
                        @Html.DisplayFor(modelItem => item.EventStatus);
                    }
                }
            </td>
            <td>
                @if (!String.IsNullOrEmpty(item.Reference))
                {
                    <a href="@appsettings.CM_Url?i_CRN=@item.Reference">@item.Reference</a>
                }
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.CreatedDate)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.UpdatedDate)
            </td>

@*
            <td>
                <ul>
                    <li @(User.IsInRole("Admins")? "" : "hidden")><a asp-action="Delete" asp-route-id="@item.ID">Delete</a></li>
                    <li @(User.IsInRole("Admins")? "" : "hidden")><a asp-action="Edit" asp-route-id="@item.ID">Edit</a></li>
                    <li><a asp-action="Details" asp-route-id="@item.ID">Details</a></li>                    
                </ul>
            </td>
*@
        </tr>
}
    </tbody>
</table>
